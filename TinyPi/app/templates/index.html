<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard • TinyPi SIEM</title>
  <link rel="stylesheet" href="/static/theme.css">
</head>
<body>
<main class="container">
  <nav>
    <ul><li><strong>TinyPi SIEM</strong></li></ul>
    <ul>
      <li><a href="/" aria-current="page">Dashboard</a></li>
      <li><a href="/logs">Logs</a></li>
      <li><a href="/alerts">Alerts</a></li>
      <li><a href="/rules">Rules</a></li>
    </ul>
  </nav>

  <section class="hero" aria-label="Overview">
    <p class="section-title">Security Overview</p>
    <h2 class="section-heading">Unified visibility for logs and alerts</h2>
    <p class="tagline">Track live syslog activity from your UniFi gateway while keeping triggered alerts clearly separated for incident response. Each panel below updates from the same data pipeline.</p>
    <div class="controls" style="margin-top:12px;">
      <button id="demo-seed" class="primary">Generate demo alerts</button>
      <button id="reset-all" class="secondary">Clear demo data</button>
      <a href="/alerts" role="button" class="secondary">View alerts</a>
    </div>
  </section>

  <section class="grid cards" aria-label="Key metrics">
    <article class="card">
      <h3>Total Syslog Events</h3>
      <p id="events-count" style="font-size:2.4em; margin:6px 0 4px 0;">—</p>
      <small>Raw messages collected and parsed</small>
    </article>
    <article class="card">
      <h3>Total Alerts</h3>
      <p id="alerts-count" style="font-size:2.4em; margin:6px 0 4px 0;">—</p>
      <small>Detections generated from rules</small>
    </article>
    <article class="card">
      <h3>Severity Mix</h3>
      <div id="severity-chart" class="grid" style="gap:8px;"></div>
      <small>Alert distribution by severity</small>
    </article>
  </section>

  <div class="grid" style="margin-top:24px; gap:20px; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));">
    <section>
      <header style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;">
        <div>
          <p class="section-title">Triggered detections</p>
          <h3 class="section-heading" style="margin:4px 0 0 0;">Alerts feed</h3>
        </div>
        <a href="/alerts" role="button" class="secondary">View all</a>
      </header>
      <ul id="alerts-feed" class="feed-list" aria-live="polite"></ul>
    </section>

    <section>
      <header style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;">
        <div>
          <p class="section-title">Freshest syslog entries</p>
          <h3 class="section-heading" style="margin:4px 0 0 0;">Live log feed</h3>
        </div>
        <a href="/logs" role="button" class="secondary">Explore logs</a>
      </header>
      <ul id="logs-feed" class="feed-list" aria-live="polite"></ul>
    </section>
  
    <section>
      <header style="display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:10px;">
        <div>
          <p class="section-title">Recent activity</p>
          <h3 class="section-heading" style="margin:4px 0 0 0;">Alerts vs syslog (last 12 hours)</h3>
        </div>
      </header>
      <div id="trend-chart" class="chart-grid"></div>
    </section>
  </div>
</main>

<script>
  async function loadStats() {
    try {
      const res = await fetch('/api/stats');
      if (!res.ok) throw new Error('Failed to load stats');
      const data = await res.json();

      document.getElementById('events-count').textContent = data.counts.events.toLocaleString();
      document.getElementById('alerts-count').textContent = data.counts.alerts.toLocaleString();

      renderSeverity(data.charts.severity || []);
      renderTrend(data.charts.trend || {});
      renderAlerts(data.feed.alerts || []);
      renderLogs(data.feed.logs || []);
    } catch (e) {
      console.error(e);
    }
  }

  function renderSeverity(rows) {
    const container = document.getElementById('severity-chart');
    container.innerHTML = '';

    if (!rows.length) {
      container.innerHTML = '<p class="empty">No alert data yet.</p>';
      return;
    }

    const total = rows.reduce((acc, row) => acc + (row.c || 0), 0) || 1;
    rows.forEach(row => {
      const percent = Math.round(((row.c || 0) / total) * 100);
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.95em;">
          <strong style="text-transform:capitalize;">${row.severity}</strong>
          <span>${row.c} · ${percent}%</span>
        </div>
        <div class="chart-bar"><div class="chart-fill" style="width:${percent}%"></div></div>
      `;
      container.appendChild(wrapper);
    });
  }

  function renderAlerts(rows) {
    const feed = document.getElementById('alerts-feed');
    feed.innerHTML = '';
    if (!rows.length) {
      feed.innerHTML = '<p class="empty">No alerts yet.</p>';
      return;
    }

    rows.forEach(row => {
      const li = document.createElement('li');
      li.className = 'feed-item';
      li.innerHTML = `
        <header>
          <span class="badge sev-${row.severity}">${row.severity}</span>
          <small>${row.ts}</small>
        </header>
        <p style="margin:6px 0 0 0; color:#e2e8f0;">${row.description}</p>
      `;
      feed.appendChild(li);
    });
  }

  function renderTrend(trend) {
    const container = document.getElementById('trend-chart');
    container.innerHTML = '';

    const alerts = trend.alerts || [];
    const events = trend.events || [];
    const hourSet = new Set([
      ...alerts.map((r) => r.hour),
      ...events.map((r) => r.hour),
    ].filter(Boolean));

    if (!hourSet.size) {
      container.innerHTML = '<p class="empty">No data yet. Generate demo alerts to populate charts.</p>';
      return;
    }

    const hours = Array.from(hourSet).sort();
    const alertMap = new Map(alerts.map((r) => [r.hour, r.c]));
    const eventMap = new Map(events.map((r) => [r.hour, r.c]));

    const maxVal = Math.max(
      ...hours.map((h) => (alertMap.get(h) || 0)),
      ...hours.map((h) => (eventMap.get(h) || 0)),
      1,
    );

    hours.forEach((hour) => {
      const alertVal = alertMap.get(hour) || 0;
      const eventVal = eventMap.get(hour) || 0;
      const row = document.createElement('div');
      row.className = 'trend-row';
      row.innerHTML = `
        <div class="trend-hour">${hour.replace('T', ' ')} UTC</div>
        <div class="trend-bars">
          <div class="chart-bar"><div class="chart-fill alerts" style="width:${(alertVal / maxVal) * 100}%"></div></div>
          <div class="chart-bar"><div class="chart-fill events" style="width:${(eventVal / maxVal) * 100}%"></div></div>
        </div>
        <div class="trend-counts">
          <span class="pill app">${eventVal} logs</span>
          <span class="pill host">${alertVal} alerts</span>
        </div>
      `;
      container.appendChild(row);
    });
  }

  function renderLogs(rows) {
    const feed = document.getElementById('logs-feed');
    feed.innerHTML = '';
    if (!rows.length) {
      feed.innerHTML = '<p class="empty">No syslog entries yet.</p>';
      return;
    }

    rows.forEach(row => {
      const li = document.createElement('li');
      li.className = 'feed-item';
      li.innerHTML = `
        <header>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
            ${row.host ? `<span class="pill host">${row.host}</span>` : ''}
            ${row.app ? `<span class="pill app">${row.app}</span>` : ''}
          </div>
          <small>${row.ts || ''}</small>
        </header>
        <p style="margin:6px 0 0 0; color:#e2e8f0;">${row.summary}</p>
      `;
      feed.appendChild(li);
    });
  }

  async function postJSON(url) {
    const res = await fetch(url, { method: 'POST' });
    if (!res.ok) throw new Error(`Request to ${url} failed`);
    return res.json();
  }

  document.getElementById('demo-seed').addEventListener('click', async () => {
    const btn = document.getElementById('demo-seed');
    btn.disabled = true;
    btn.textContent = 'Generating…';
    try {
      await postJSON('/demo/seed');
      await loadStats();
    } catch (e) {
      console.error(e);
      alert('Unable to generate demo data. Check server logs.');
    } finally {
      btn.disabled = false;
      btn.textContent = 'Generate demo alerts';
    }
  });

  document.getElementById('reset-all').addEventListener('click', async () => {
    if (!confirm('This will clear all events and alerts. Continue?')) return;
    try {
      await postJSON('/reset/all');
      await loadStats();
      document.getElementById('alerts-feed').innerHTML = '<p class="empty">No alerts yet.</p>';
      document.getElementById('logs-feed').innerHTML = '<p class="empty">No syslog entries yet.</p>';
      document.getElementById('severity-chart').innerHTML = '<p class="empty">No alert data yet.</p>';
      document.getElementById('trend-chart').innerHTML = '<p class="empty">No data yet. Generate demo alerts to populate charts.</p>';
    } catch (e) {
      console.error(e);
      alert('Unable to clear data.');
    }
  });

  loadStats();
</script>
</body>
</html>
