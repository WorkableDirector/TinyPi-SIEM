<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Alerts • TinyPi SIEM</title>
  <link rel="stylesheet" href="/static/theme.css">
</head>
<body>
<main class="container">
  <nav>
    <ul><li><strong>TinyPi SIEM</strong></li></ul>
    <ul>
      <li><a href="/">Dashboard</a></li>
      <li><a href="/logs">Logs</a></li>
      <li><a href="/alerts" aria-current="page">Alerts</a></li>
      <li><a href="/rules">Rules</a></li>
      <li><a href="/demo">Demo</a></li>
    </ul>
  </nav>

  <section class="hero">
    <p class="section-title">Triggered detections</p>
    <h2 class="section-heading">Alerts are tracked separately from raw logs</h2>
    <p class="tagline">Use the filters to focus on severities or keywords without touching the syslog archive. Clearing alerts here does not impact the underlying events.</p>
    <div class="controls" style="margin-top:10px;">
      <a href="/" role="button" class="secondary">Back to Dashboard</a>
      <a href="/logs" role="button" class="secondary">View raw logs</a>
      <button id="demo-seed" class="primary" type="button">Generate demo alerts</button>
    </div>
  </section>

  <form class="filters" method="get" action="/alerts" style="align-items:flex-end;">
    <div>
      <label for="severity">Severity</label>
      <select id="severity" name="severity">
        <option value="" {% if not filters.severity %}selected{% endif %}>All severities</option>
        <option value="critical" {% if filters.severity == 'critical' %}selected{% endif %}>Critical</option>
        <option value="high" {% if filters.severity == 'high' %}selected{% endif %}>High</option>
        <option value="medium" {% if filters.severity == 'medium' %}selected{% endif %}>Medium</option>
        <option value="low" {% if filters.severity == 'low' %}selected{% endif %}>Low</option>
      </select>
    </div>
    <div>
      <label for="search">Description contains</label>
      <input id="search" name="search" type="search" value="{{ filters.search }}" placeholder="ssh brute force" />
    </div>
    <div>
      <label for="limit">Max rows</label>
      <input id="limit" name="limit" type="number" min="10" max="500" value="{{ filters.limit }}" />
    </div>
    <div class="controls">
      <button class="primary" type="submit">Apply filters</button>
      <a href="/alerts" role="button" class="secondary">Reset</a>
      <button id="refresh-alerts" class="secondary" type="button">Refresh</button>
      <button id="clear-alerts" class="secondary" type="button">Clear All Alerts</button>
    </div>
  </form>

  <small class="section-title">Showing {{ rows|length }} alert{{ 's' if rows|length != 1 else '' }} (limit {{ filters.limit }})</small>

  <article class="card table-card" style="margin-top:12px;">
    <table>
      <thead>
        <tr><th>ID</th><th>Time (UTC)</th><th>Severity</th><th>Description</th><th>Log ID</th></tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td>{{ r['id'] }}</td>
            <td>{{ r['ts'] }}</td>
            <td><span class="badge sev-{{ r['severity'] }}">{{ r['severity'] }}</span></td>
            <td><code>{{ r['description'] }}</code></td>
            <td>{{ r['related_event_id'] or '' }}</td>
          </tr>
        {% else %}
          <tr><td colspan="5" class="empty">No alerts yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </article>
</main>

<script>
  document.getElementById('clear-alerts').addEventListener('click', async function() {
    if (confirm('Are you sure you want to clear all alerts?')) {
      try {
        await fetch('/reset/alerts', { method: 'POST' });
        window.location.href = '/alerts';
      } catch (e) {
        console.error("Error clearing alerts:", e);
      }
    }
  });

  document.getElementById('refresh-alerts').addEventListener('click', function() {
    window.location.href = window.location.pathname + window.location.search;
  });

  const demoBtn = document.getElementById('demo-seed');
  demoBtn?.addEventListener('click', async function() {
    demoBtn.disabled = true;
    demoBtn.textContent = 'Generating…';
    try {
      await fetch('/demo/seed', { method: 'POST' });
      window.location.href = window.location.pathname + window.location.search;
    } catch (e) {
      alert('Unable to generate demo alerts.');
    } finally {
      demoBtn.disabled = false;
      demoBtn.textContent = 'Generate demo alerts';
    }
  });
</script>
</body>
</html>
